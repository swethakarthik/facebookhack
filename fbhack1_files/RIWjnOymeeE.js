/*!CK:2919964852!*//*1395630039,178158627*/

if (self.CavalryLogger) { CavalryLogger.start_js(["JMDX6"]); }

__d("ImageResizer",["ArbiterMixin","BlobFactory","DOM","UserAgent","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k){var l=function(m,n,o,p,q){this._input=m;this._image=null;this._canvas=null;this._rotation=0;this._maxWidth=n;this._maxHeight=o;this._outputMime=p||'image/jpeg';this._outputQuality=(q===undefined)?.87:q;};l.isSupported=function(){if(window.File&&window.FileReader){var m=i.create('canvas');if(m.toBlob||(m.toDataURL&&window.ArrayBuffer&&window.Uint8Array&&h.isSupported()))return true;}return false;};k(l.prototype,g);k(l.prototype,{setOrientation:function(m){this._rotation={1:0,3:180,6:90,8:270}[m]||0;},resize:function(){if(this._input instanceof HTMLCanvasElement||this._input instanceof HTMLImageElement){this._image=this._input;this._handleImage();}else if(typeof this._input=="string"){this._loadImage(this._input);}else if(this._input instanceof window.File)this._loadFile(this._input);},_rotatedToSide:function(){return (this._rotation%180)==90;},_prepareError:function(m){return (function(){this.inform.bind(this,"error",m);}.bind(this));},_loadFile:function(m){this._fileLoadTime=Date.now();var n=new FileReader();n.onload=this._handleFile.bind(this);n.onerror=this._prepareError("Could not read tile.");n.readAsDataURL(m);},_handleFile:function(event){this._fileLoadTime=Date.now()-this._fileLoadTime;var m=event.target.result;this._loadImage(m);},_loadImage:function(m){this._imageLoadTime=Date.now();this._image=i.create('img');this._image.onload=this._handleImage.bind(this);this._image.onerror=this._prepareError("Could not load image.");this._image.src=m;},_handleImage:function(){if(this._imageLoadTime)this._imageLoadTime=Date.now()-this._imageLoadTime;if(this._input instanceof window.File){var m=this._calculateRatio();if(m>=1){this._skippedResizing=true;return this._handleBlob(this._input);}}this._skippedResizing=false;this._drawTransformed();this._extractBlob();},_drawTransformed:function(){var m=Date.now(),n=this._calculateRatio(),o=0;if(j.chrome())if(n<.25){o=2;}else if(n<.5)o=1;var p=this._drawResizedCanvas(this._image,n*Math.pow(2,o));for(var q=0;q<o;q++)p=this._drawResizedCanvas(p,.5);if(this._rotation)p=this._drawRotatedCanvas(p);this._canvas=p;this._drawTime=Date.now()-m;},_drawResizedCanvas:function(m,n){var o=i.create('canvas');o.width=m.width*n;o.height=m.height*n;var p=o.getContext("2d");p.scale(n,n);p.drawImage(m,0,0);return o;},_drawRotatedCanvas:function(m){var n=i.create('canvas');if(this._rotatedToSide()){n.width=m.height;n.height=m.width;}else{n.width=m.width;n.height=m.height;}var o=n.getContext("2d");o.translate(n.width*.5,n.height*.5);o.rotate(Math.PI*(this._rotation/180));o.translate(m.width*-.5,m.height*-.5);o.drawImage(m,0,0,m.width,m.height);return n;},_calculateRatio:function(){var m=1,n=this._rotatedToSide()?this._maxHeight:this._maxWidth,o=this._rotatedToSide()?this._maxWidth:this._maxHeight,p=n/this._image.width,q=o/this._image.height;if(p<m&&p>0)m=p;if(q<m&&q>0)m=q;return m;},_extractBlob:function(){this._extractionStart=Date.now();if(this._canvas.toBlob){this._canvas.toBlob(this._handleBlob.bind(this),this._outputMime,this._outputQuality);return;}var m=this._canvas.toDataURL(this._outputMime,this._outputQuality),n=m.match(/^data:(.*?);base64,/);if(!n){this._prepareError("Couldn't get base64 encoded data from canvas.")();return;}var o=n[1],p=m.substr(n[0].length),q=window.atob(p),r=new ArrayBuffer(q.length),s=new Uint8Array(r);for(var t=0;t<q.length;t++)s[t]=q.charCodeAt(t);var u=h.getBlob([r],{type:o});this._handleBlob(u);},_handleBlob:function(m){this._canvas=this._canvas||i.create('canvas');m.performanceData={blockingDraw:+true,blockingExtraction:+!this._canvas.toBlob,imageLoadTime:this._imageLoadTime,fileLoadTime:this._fileLoadTime,skippedResizing:+this._skippedResizing};if(!this._skippedResizing)k(m.performanceData,{extractionTime:Date.now()-this._extractionStart,drawTime:this._drawTime});this.inform('resized',m);}});e.exports=l;});
__d("PhotosUploadWaterfallMixin",["PhotosUploadWaterfall","copyProperties","emptyFunction"],function(a,b,c,d,e,f,g,h,i){var j={getUploaderApp:i,getWaterfallID:i,logWaterfallStep:function(k,l,m){g.sendSignal(h({qn:this.getWaterfallID(),uploader:this.getUploaderApp(),step:k},l),m);}};e.exports=j;});
__d("FilePickerEvent",[],function(a,b,c,d,e,f){e.exports={BEGIN:'FilePickerEvent/BEGIN',SELECTED:'FilePickerEvent/SELECTED_FILES',MAX_EXCEEDED:'FilePickerEvent/MAX_EXCEEDED',SELECT_CANCELED:'FilePickerEvent/SELECT_CANCELED',FALLBACK:'FilePickerEvent/FALLBACK'};});
__d("FlashArbiterEvents",["Arbiter","Run"],function(a,b,c,d,e,f,g,h){function i(j){"use strict";this._flashID=j;this._subscriptions=[];h.onLeave(this.unsubscribeAll.bind(this));}i.prototype.subscribe=function(j,k){"use strict";var l=this._flashID;this._subscriptions.push(g.subscribe(j,function(m,n){if(l===n.divID)k(n);}));return this;};i.prototype.unsubscribeAll=function(){"use strict";while(this._subscriptions.length)g.unsubscribe(this._subscriptions.pop());};e.exports=i;});
__d("FlashLoadEvent",[],function(a,b,c,d,e,f){e.exports={READY:'flash/ready',FAILED:'flash/failed',MOUSE_CANCELED:'UploadEvent/SELECT_CANCELED',MOUSE_DOWN:'UploadEvent/SELECT_DOWN',MOUSE_OUT:'UploadEvent/SELECT_OUT',MOUSE_OVER:'UploadEvent/SELECT_OVER',MOUSE_UP:'UploadEvent/SELECT_UP',ERROR_FLASH_LOAD_TIMEOUT:1,ERROR_FLASH_LOAD_FAILURE:2,ERROR_FLASH_UPGRADE_REQUIRED:3};});
__d("UploadEvent",[],function(a,b,c,d,e,f){var g={UPLOAD_START:'UploadEvent/UPLOAD_START',UPLOAD_HIRES_RESTART:'UploadEvent/UPLOAD_HIRES_RESTART',START:'UploadEvent/START',DONE:'UploadEvent/DONE',ERROR:'UploadEvent/ERROR',FINISHED_UPLOADING:'UploadEvent/FINISHED_UPLOADING',LOADED:'UploadEvent/LOADED',READY:'UploadEvent/READY',UPLOAD_FAILED:'UploadEvent/UPLOAD_FAILED',UPLOAD_PROGRESS:'UploadEvent/UPLOAD_PROGRESS',COMPRESS_PROGRESS:'UploadEvent/COMPRESS_PROGRESS',HI_RES_ATTACH_START:'UploadEvent/HI_RES_ATTACH_START',IMAGE_COMPRESS_ERROR:'UploadEvent/IMAGE_COMPRESS_ERROR',IMAGE_COMPRESS_BEGIN:'UploadEvent/IMAGE_COMPRESS_BEGIN',IMAGE_COMPRESSED:'UploadEvent/IMAGE_COMPRESSED',IMAGE_UPLOAD_ERROR:'UploadEvent/IMAGE_UPLOAD_ERROR',IMAGE_UPLOADED:'UploadEvent/IMAGE_UPLOADED',SELECT_START:'UploadEvent/SELECT_START',IMAGES_SELECTED:'UploadEvent/IMAGES_SELECTED',HEARTBEAT:'UploadEvent/HEARTBEAT'};e.exports=g;});
__d("FlashFilePicker",["Arbiter","ArbiterMixin","AsyncUploadBase","ImageResizer","CSS","FilePickerEvent","Flash","FlashArbiterEvents","FlashLoadEvent","FlashUploaderConfig","Parent","PhotosUploadWaterfall","PhotosUploadWaterfallMixin","UploadEvent","URI","copyProperties","$"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){function x(ba){for(var ca=0;ca<ba.length;++ca)if(m.checkMinVersion(ba[ca].toString()))return true;return false;}function y(ba){var ca=q.byClass(ba,'addPhotosDisabled');if(ca){k.removeClass(ca,'addPhotosDisabled');k.addClass(ca,'addPhotosEnabled');}}function z(ba,ca){ca.style.width=ba.offsetWidth+'px';ca.style.height=ba.offsetHeight+'px';}function aa(ba,ca,da){this._swfID=ba;this._button=ca;this._waterfallID=da.qn;this._beginInformed=false;this._isReady=false;this._fallbackHref=da.fallbackHref;if(!x(p.flashVersionInfo.minimumVersion)){this.logWaterfallStep(r.UPGRADE_REQUIRED);this._flashError(o.ERROR_FLASH_UPGRADE_REQUIRED);return;}this._flashEvents=new n(this._swfID).subscribe(o.READY,this._handleReady.bind(this)).subscribe(o.FAILED,this._handleFailed.bind(this)).subscribe(o.MOUSE_OVER,this._handleMouseIn.bind(this)).subscribe(o.MOUSE_OUT,this._handleMouseOut.bind(this)).subscribe(t.SELECT_START||'UploadEvent/SELECT_START',this._handleSelectStart.bind(this)).subscribe(t.IMAGES_SELECTED,this._handleSelected.bind(this));this._timeout=setTimeout(function(){if(!this._isReady)this._flashError(o.ERROR_FLASH_LOAD_TIMEOUT);}.bind(this),p.flashLoadTimeout);da.logDetailed&&this.logDetailed();}v(aa.prototype,h,s,{getUploaderApp:function(){return r.APP_FLASH;},getWaterfallID:function(){return this._waterfallID;},logDetailed:function(){this.logWaterfallStep(r.VERSION,{version:m.getVersion().join('.')});if(i.isSupported()){this.logWaterfallStep(r.ASYNC_AVAILABLE);if(j.isSupported())this.logWaterfallStep(r.RESIZER_AVAILABLE);}},_handleReady:function(ba){z(this._button,w(this._swfID));y(this._button);this._isReady=true;clearTimeout(this._timeout);g.inform(t.READY,{divID:this._swfID},g.BEHAVIOR_PERSISTENT);},_handleFailed:function(ba){this._flashError(o.ERROR_FLASH_LOAD_FAILURE);},_flashError:function(ba){if(this._fallbackHref){var ca=u(this._fallbackHref).addQueryData({error:ba}).toString();this._button.removeAttribute('rel');this._button.removeAttribute('ajaxify');this._button.setAttribute('href',ca);y(this._button);}this.logWaterfallStep(r.CLIENT_ERROR,{code:ba,scuba_tags:{fallback_simple:true}});},_handleMouseIn:function(ba){k.addClass(this._button,'selectOver');},_handleMouseOut:function(ba){k.removeClass(this._button,'selectOver');},_handleSelectStart:function(ba){if(!this._beginInformed){this._beginInformed=true;this.inform(l.BEGIN||'FilePickerEvent/BEGIN');}},_handleSelected:function(ba){var ca;if(ba.files){ca=ba.files;}else{ca=[{uploadID:ba.divID+'.'}];ca.length=ba.count;}this.inform(l.SELECTED,{sender:this,files:ca},g.BEHAVIOR_PERSISTENT);}});e.exports=aa;});
__d("UploadSession",["AsyncRequest","FilePickerEvent","PhotosUploadWaterfall","arrayContains"],function(a,b,c,d,e,f,g,h,i,j){var k={};function l(n){"use strict";this._sessionID=n;this._asyncBootstrapped=false;this._controller=null;this._overlay=null;this._pickers=[];this._pendingFileLists=[];this._beginLogged=false;}l.prototype.addFilePicker=function(n){"use strict";if(!j(this._pickers,n)){this._pickers.push(n);n.subscribe(h.BEGIN,function(o,p){if(!this._beginLogged){this._beginLogged=true;i.sendSignal({qn:n.getWaterfallID(),step:i.BEGIN,uploader:n.getUploaderApp()});}}.bind(this));n.subscribe(h.SELECTED,function(o,p){if(this._controller){this._controller.uploadFiles(p.files);}else this._pendingFileLists.push(p);if(this._asyncBootstrapped)return;var q=n._button;g.bootstrap(q.getAttribute('ajaxify'),q,true);this._asyncBootstrapped=true;}.bind(this));}};l.prototype.addController=function(n){"use strict";this._controller=n;this._asyncBootstrapped=true;var o=(this._controller.getWaterfallID)?this._controller.getWaterfallID():this._controller.getWaterfallConfig().waterfallID,p=(this._controller.getUploaderApp)?this._controller.getUploaderApp():this._controller.getWaterfallConfig().waterfallApp;if(!this._beginLogged){this._beginLogged=true;i.sendSignal({qn:o,step:i.BEGIN,uploader:p});}if(this._pendingFileLists.length){var q=[];this._pendingFileLists.forEach(function(r){q=q.concat(r.files);});this._controller.uploadFiles(q);}else i.sendSignal({qn:o,step:i.OVERLAY_FIRST,uploader:p});};l.prototype.addOverlay=function(n){"use strict";this._overlay=n;};l.addFilePickerToSession=function(n,o){"use strict";m(n).addFilePicker(o);};l.addControllerToSession=function(n,o){"use strict";m(n).addController(o);};l.addOverlayToSession=function(n,o){"use strict";m(n).addOverlay(o);};function m(n){if(!k[n])k[n]=new l(n);return k[n];}e.exports=l;});
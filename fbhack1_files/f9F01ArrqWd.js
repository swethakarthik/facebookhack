/*!CK:3431198605!*//*1394332435,178134569*/

if (self.CavalryLogger) { CavalryLogger.start_js(["M9ILn"]); }

__d("FaceboxSourceConstants",[],function(a,b,c,d,e,f){e.exports={SNOWLIFT_SUGGEST:"snowlift_suggest",SNOWLIFT_DISMISS:"photo_snowlift_unit_suggestions",PERMALINK_SUGGEST:"permalink_suggest",PERMALINK_DISMISS:"photo_permalink_suggestions",UPLOADER_SUGGEST:"uploader_suggest",UPLOADER_DISMISS:"album_uploader_suggestions"};});
__d("TimelineProfilePictureLoggerEnums",[],function(a,b,c,d,e,f){e.exports={actions:{EDIT_THUMBNAIL:"edit_thumbnail",FROM_PHOTOS:"from_photos",MAKE_PROFILE:"make_profile",SILHOUETTE:"silhouette",SYNCED_PHOTO:"synced_photo",TAKE_PHOTO:"take_photo",UPLOAD:"upload_photo",USE_PREVIOUS:"use_previous"},steps:{INIT:"init",CANCEL:"cancel",FAIL:"fail",CROP:"crop",LOADING:"loading",SUCCESS:"success"}};});
__d("clamp",[],function(a,b,c,d,e,f){function g(h,i,j){if(i<h)return h;if(i>j)return j;return i;}e.exports=g;});
__d("PhotoTagApproval",["Arbiter","CSS","DOM","Event","Parent","PhotosConst","ge"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(o){"use strict";this.viewer=o;this.units=[];this.currentUnit=0;var p=o.getVersionConst();if(p==l.VIEWER_SNOWLIFT){this._root=m('fbPhotoSnowliftTagApproval');}else this._root=m('fbPhotoPageTagApproval');g.subscribe(o.getEventString('DATA_CHANGE'),this.restartTagApproval.bind(this));g.subscribe('PhotoTagApproval.PENDING_TAG_PHOTO_CLICK',this.pendingTagPhotoClick.bind(this));j.listen(this._root,'click',this.handleClick.bind(this));j.listen(this._root,'mousemove',function(q){this.hiliteCurrentPendingTag();j.kill(q);}.bind(this));this.restartTagApproval();}n.prototype.handleClick=function(event){"use strict";var o=event.getTarget();if(h.hasClass(o,'nextPager')&&h.hasClass(o,'enabled')){this.showNextUnit();}else if(h.hasClass(o,'prevPager')&&h.hasClass(o,'enabled')){this.showPrevUnit();}else if(k.byClass(o,'fbPhotoApprovalPendingButtons')){var p=this.units[this.currentUnit],q=this.getTagNameID(p);if(q){var r=k.byClass(o,'approve');g.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:q,approve:r,version:this.viewer.getVersionConst()});}setTimeout(this.removeSelectedUnit.bind(this),0);}return true;};n.prototype.loadUnits=function(o){"use strict";this.units=i.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){h.show(this._root);this.showUnit(o);h.conditionClass(this._root,'hidePagers',this.units.length==1);}else{h.hide(this._root);g.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this.viewer.getVersionConst()});}};n.prototype.restartTagApproval=function(){"use strict";this.loadUnits(0);};n.prototype.pendingTagPhotoClick=function(o,p){"use strict";if(p.version!==l.VIEWER_PERMALINK&&p.version!==l.VIEWER_SNOWLIFT)return true;var q='approve:'+p.id;for(var r=0;r<this.units.length;r++)if(this.units[r].id===q){this.showUnit(r);return false;}return true;};n.prototype.removeSelectedUnit=function(){"use strict";var o=this.units[this.currentUnit];i.remove(o);this.loadUnits(this.currentUnit);};n.prototype.showNextUnit=function(){"use strict";this.showUnit(this.currentUnit+1);};n.prototype.showPrevUnit=function(){"use strict";this.showUnit(this.currentUnit-1);};n.prototype.getTagNameID=function(o){"use strict";var p=o.id.indexOf(':');return o.id.slice(p+1);};n.prototype.showUnit=function(o){"use strict";this.units.forEach(h.hide);this.currentUnit=(o+this.units.length)%this.units.length;var p=this.units[this.currentUnit];h.show(p);this.hiliteCurrentPendingTag();h.conditionClass(i.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);h.conditionClass(i.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);};n.prototype.hiliteCurrentPendingTag=function(){"use strict";var o=this.units[this.currentUnit],p=this.getTagNameID(o);g.inform('PhotoTagApproval.HILITE_TAG',{tag:p,version:this.viewer.getVersionConst()});};e.exports=n;});
__d("legacy:photo-tag-approval",["PhotoTagApproval"],function(a,b,c,d){a.PhotoTagApproval=b('PhotoTagApproval');},3);
__d("PhotoTagStore",["AsyncRequest","copyProperties","isEmpty"],function(a,b,c,d,e,f,g,h,i){function j(){"use strict";this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};j.instance=this;}j.prototype.getPhotoTags=function(k){"use strict";return this._tagList[k]||{};};j.prototype.photoHasTags=function(k){"use strict";return !i(this.getPhotoTags(k));};j.prototype.clear=function(){"use strict";this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};};j.prototype.revert=function(k){"use strict";for(var l in this._tagList)if(!this._originalTagList[l][k]){delete this._tagList[l][k];}else this._tagList[l][k]=this._originalTagList[l][k];this._dirtyPhotosByUid={};};j.prototype.hasNewTags=function(){"use strict";return !i(this._tagList)||!i(this._textTagList);};j.prototype.userHasDirtyTags=function(k){"use strict";return !i(this._dirtyPhotosByUid[k]);};j.prototype.userDirtyTagsCount=function(k){"use strict";return Object.keys(this._dirtyPhotosByUid[k]).length;};j.prototype.handleTagFetch=function(k){"use strict";for(var l in k)this.loadTagInfo(l,k[l]);};j.prototype.saveAlbumTagsForUser=function(k,l){"use strict";var m={},n=[],o=this._dirtyPhotosByUid[k]||{};for(var p in o){var q=this._tagList[p][k];if(q===undefined){n[n.length]=p;continue;}m[p]={x:q.x,y:q.y};}var r={subject:k,action:'save',save_tags:m,remove_from:n};new g().setURI('/ajax/photos/album/tags.php').setData(r).setHandler(function(s){l(s.payload);}).setAllowCrossPageTransition(true).send();delete this._dirtyPhotosByUid[k];};j.prototype.getTagsFromList=function(k){"use strict";var l=[];for(var m in k)if(k.hasOwnProperty(m))for(var n in k[m])if(k[m].hasOwnProperty(n))l.push(k[m][n]);return l;};j.prototype.getAllTags=function(){"use strict";var k=this.getTagsFromList(this._tagList),l=this.getTagsFromList(this._textTagList);return k.concat(l);};j.prototype.removeTag=function(k,l){"use strict";var m=this._tagList[k],n=this._originalTagList[k]||{};if(n[l]){this._dirtyPhotosByUid[l]=this._dirtyPhotosByUid[l]||{};this._dirtyPhotosByUid[l][k]=true;}else delete this._dirtyPhotosByUid[l][k];for(var o in m)if(o==l){var p=this._tagList[k][o];delete this._tagList[k][o];if(i(this._tagList[k]))delete this._tagList[k];return p;}};j.prototype.removeTextTag=function(k,l){"use strict";var m=this._textTagList[k];if(!i(m[l])){var n=this._textTagList[k][l];delete this._textTagList[k][l];if(i(this._textTagList[k]))delete this._textTagList[k];return n;}};j.prototype.removeAllNewTagsOfUser=function(k){"use strict";var l=[];if(!this.userHasDirtyTags(k))return l;var m=this._dirtyPhotosByUid[k];for(var n in m)l.push(this.removeTag(n,k));return l;};j.prototype.removeAllTagsFromPhoto=function(k){"use strict";var l=[];if(!i(this._tagList[k]))for(var m in this._tagList[k]){if(!this._tagList[k].hasOwnProperty(m))continue;l.push(this.removeTag(k,m));}if(!i(this._textTagList[k]))for(var n in this._textTagList[k]){if(!this._textTagList[k].hasOwnProperty(n))continue;l.push(this.removeTextTag(k,n));}return l;};j.prototype.storeTag=function(k,l,m,n,o){"use strict";this.storeTagWithOptions(k,l,m,n,{can_remove:o});};j.prototype.storeTagWithOptions=function(k,l,m,n,o){"use strict";this._dirtyPhotosByUid[l]=this._dirtyPhotosByUid[l]||{};this._dirtyPhotosByUid[l][k]=true;var p={x:m,y:n};h(p,o);if(!l){this._textTagList[k]=this._textTagList[k]||{};this._textTagList[k][p.name]=p;}else{this._tagList[k]=this._tagList[k]||{};this._tagList[k][l]=p;}};j.prototype.loadTagInfo=function(k,l){"use strict";this._tagList[k]={};this._originalTagList[k]={};for(var m=0;m<l.length;m++){var n=l[m];this._tagList[k][n.subject]=n;this._originalTagList[k][n.subject]=n;}};j.getInstance=function(){"use strict";if(j.instance===null)new j();return j.instance;};j.instance=null;e.exports=j;});
__d("PhotosTaggingWaterfall",["AsyncSignal","copyProperties"],function(a,b,c,d,e,f,g,h){function i(j){i._queueName=j||i._queueName;}h(i,{BEGIN:"begin",TAG_FACE:"tag_face",HOVER_TAG_FACE:"hover_tag_face",SHOW_SUGGEST:"show_suggest",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function(j,k){new g('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(j)}).setHandler(k).send();}});e.exports=i;});
__d("ProfilePicRequestCreator",["Form","copyProperties"],function(a,b,c,d,e,f,g,h){function i(j,k,l,m){"use strict";this._fbid=j;this._owner=k;this._profileID=l;this._area=m;}i.prototype.setSuccessURI=function(j){"use strict";this._successURI=j;return this;};i.prototype.setErrorURI=function(j){"use strict";this._errorURI=j;return this;};i.prototype.setIsUnscaled=function(j){"use strict";this._isUnscaled=j;return this;};i.prototype.setProfilePhotoSource=function(j){"use strict";this._source=j;return this;};i.prototype.setProfilePhotoMethod=function(j){"use strict";this._method=j;return this;};i.prototype.send=function(){"use strict";var j=h({fbid:this._fbid,owner:this._owner,id:this._profileID,'return':this._successURI,error_return:this._errorURI,is_unscaled:this._isUnscaled,source:this._source,method:this._method},this._area);g.post('/crop_profile_pic.php',j);};e.exports=i;});
__d("PhotocropConstraintConstants",[],function(a,b,c,d,e,f){var g={BOUNDARY:'boundary',SQUARE:'square',WIDE:'wide'};g.getAspectRatioForType=function(h){switch(h){case g.SQUARE:return 1;case g.WIDE:return 16/9;default:return null;}};e.exports=g;});
__d("PhotocropConstraint",["Vector","PhotocropConstraintConstants","clamp"],function(a,b,c,d,e,f,g,h,i){function j(p){"use strict";this.photocrop=p;this.pos=null;}j.prototype.onMouseMove=function(p,q,r){"use strict";var s=p.sub(this.pos);if(q){this.onResize(s,r);}else this.onMove(s);this.pos=this.pos.add(s);};j.prototype.onMouseDown=function(p){"use strict";this.pos=p;};j.prototype.onResize=function(p,q){"use strict";};j.prototype.onMove=function(p){"use strict";var q=this.photocrop.box,r=this.photocrop.wrapper.offsetWidth,s=this.photocrop.wrapper.offsetHeight;p.x=i(-q.l,p.x,r-q.r);p.y=i(-q.t,p.y,s-q.b);this.photocrop.box=q.add(p);};for(var k in j)if(j.hasOwnProperty(k))m[k]=j[k];var l=j===null?null:j.prototype;m.prototype=Object.create(l);m.prototype.constructor=m;m.__superConstructor__=j;function m(){"use strict";if(j!==null)j.apply(this,arguments);}m.prototype.onResize=function(p,q){"use strict";var r=this.photocrop.min_width,s=this.photocrop.min_height,t=this.photocrop.box,u=this.photocrop.wrapper.offsetWidth,v=this.photocrop.wrapper.offsetHeight;switch(q){case 'ne':t.r+=p.x=i(t.l+r-t.r,p.x,u-t.r);t.t+=p.y=i(-t.t,p.y,t.b-s-t.t);break;case 'nw':t.l+=p.x=i(-t.l,p.x,t.r-r-t.l);t.t+=p.y=i(-t.t,p.y,t.b-s-t.t);break;case 'se':t.r+=p.x=i(t.l+r-t.r,p.x,u-t.r);t.b+=p.y=i(t.t+s-t.b,p.y,v-t.b);break;case 'sw':t.l+=p.x=i(-t.l,p.x,t.r-r-t.l);t.b+=p.y=i(t.t+s-t.b,p.y,v-t.b);break;}};for(k in j)if(j.hasOwnProperty(k))n[k]=j[k];n.prototype=Object.create(l);n.prototype.constructor=n;n.__superConstructor__=j;function n(){"use strict";if(j!==null)j.apply(this,arguments);}n.prototype.setRatio=function(p){"use strict";this.ratio=p;return this;};n.prototype.onMouseDown=function(p){"use strict";l.onMouseDown.call(this,p);var q=this.photocrop.box,r=q.r-q.l,s=q.b-q.t;this.displacement=new g(r,s);};n.prototype.$AspectRatioConstraint0=function(p,q,r,s,t,u){"use strict";var v,w,x,y,z;v=this.displacement.x/this.displacement.y;w=y=i(p,q,r);x=z=i(s,t,u);if(v>this.ratio){x=i(s,w/this.ratio,u);w=x*this.ratio;}else{w=i(p,x*this.ratio,r);x=w/this.ratio;}return new g(w,x);};n.prototype.onResize=function(p,q){"use strict";var r=this.photocrop.min_width,s=this.photocrop.min_height,t=this.photocrop.box,u=this.photocrop.wrapper.offsetWidth,v=this.photocrop.wrapper.offsetHeight,w;switch(q){case 'ne':this.displacement=this.displacement.add(p.x,-p.y);w=this.$AspectRatioConstraint0(r,this.displacement.x,u-t.l,s,this.displacement.y,t.b);t.r=t.l+w.x;t.t=t.b-w.y;break;case 'nw':this.displacement=this.displacement.add(-p.x,-p.y);w=this.$AspectRatioConstraint0(r,this.displacement.x,t.r,s,this.displacement.y,t.b);t.l=t.r-w.x;t.t=t.b-w.y;break;case 'se':this.displacement=this.displacement.add(p.x,p.y);w=this.$AspectRatioConstraint0(r,this.displacement.x,u-t.l,s,this.displacement.y,v-t.t);t.r=t.l+w.x;t.b=t.t+w.y;break;case 'sw':this.displacement=this.displacement.add(-p.x,p.y);w=this.$AspectRatioConstraint0(r,this.displacement.x,t.r,s,this.displacement.y,v-t.t);t.l=t.r-w.x;t.b=t.t+w.y;break;}};function o(p,q){var r;switch(q){case h.BOUNDARY:r=new m(p);break;case h.WIDE:case h.SQUARE:r=new n(p).setRatio(h.getAspectRatioForType(q));break;default:throw Error('unsupported PhotocropConstraint type');}return r;}e.exports=o;});
__d("Photocrop2",["ArbiterMixin","PhotocropConstraintConstants","CSS","DOM","Event","ProfilePictureCropConfig","Rect","Vector","copyProperties","mixin","PhotocropConstraint"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=p(g);for(var s in r)if(r.hasOwnProperty(s))u[s]=r[s];var t=r===null?null:r.prototype;u.prototype=Object.create(t);u.prototype.constructor=u;u.__superConstructor__=r;function u(v,w,x){"use strict";this.photo=v;var y=this.getPhotoDimensions();if(x){this.imageDimensions=new n(x.x,x.y);}else this.imageDimensions=new n(y.x,y.y);w.height=w.height||l.default_size;w.width=w.width||l.default_size;o(this,{target:this.photo.parentNode,create_target:false,target_parent:this.photo.parentNode,min_width:l.min_size,min_height:l.min_size,center_x:(y.x||w.width)/2,center_y:(y.y||w.height)/2,constraint_type:l.constraint_type},w);this._unscaledMinHeight=this.min_height;this._unscaledMinWidth=this.min_width;this._unscaledHeight=this.height;this._unscaledWidth=this.width;this.setInitialDimensionsAndPos();if(this.create_target){this.target=j.create('div');i.addClass(this.target,'stageCropper');this.target_parent.appendChild(this.target);}i.addClass(this.target,'photocrop');['bg','wrapper','viewport'].forEach(function(z){this[z]=j.create('div');i.addClass(this[z],z);}.bind(this));this.highlight=j.create('img');i.addClass(this.highlight,'highlight');this.setHighlightSource();i.addClass(this.wrapper,'photocropWrapper');this.target.appendChild(this.bg);this.target.appendChild(this.wrapper);this.wrapper.appendChild(this.highlight);this.wrapper.appendChild(this.viewport);['ne','nw','sw','se'].forEach(function(z){var aa=j.create('div');i.addClass(aa,z);aa.setAttribute('data-cropcorner',z);this.viewport.appendChild(aa);i.addClass(aa,'profilePicViewportGrabby');}.bind(this));k.listen(this.viewport,{mousedown:this.mousedown.bind(this),dragstart:k.kill,selectstart:k.kill,click:k.stop});k.listen(document,{mousemove:this.mousemove.bind(this),mouseup:this.mouseup.bind(this)});k.listen(window,{resize:this.adjustForResize.bind(this)});this.realignToPictureSize();this.redraw();}u.prototype.setInitialDimensionsAndPos=function(){"use strict";this._constraint=q(this,this.constraint_type);var v=h.getAspectRatioForType(this.constraint_type),w=this.getPhotoDimensions();if(v){this._unscaledMinHeight=this._unscaledMinWidth/v;this._unscaledHeight=this._unscaledWidth/v;}this.setNewRatio();var x=Math.min(this.width,w.x),y=Math.min(this.height,w.y);this.min_width=Math.min(this.min_width,w.x);this.min_height=Math.min(this.min_height,w.y);if(v)if(w.x/w.y>v){y=Math.min(y,w.y);x=y*v;this.min_width=this.min_height*v;}else{x=Math.min(x,w.x);y=x/v;this.min_height=this.min_width/v;}var z=this.center_x-x/2,aa=this.center_y-y/2;this.box=new m(aa,z+x,aa+y,z);};u.prototype.getPhotoDimensions=function(){"use strict";return n.getElementDimensions(this.photo);};u.prototype.getPhotoPosition=function(){"use strict";return new n(this.photo.offsetLeft,this.photo.offsetTop);};u.prototype.setHighlightSource=function(){"use strict";this.highlight.src=this.photo.src;};u.prototype.setConstraintType=function(v){"use strict";this.constraint_type=v;this.setInitialDimensionsAndPos();this.adjustForResize();};u.prototype.adjustForResize=function(){"use strict";var v=this.ratio,w=this.setNewRatio(),x=w/v;this.box.t*=x;this.box.l*=x;this.box.b*=x;this.box.r*=x;this.redraw();this.realignToPictureSize();};u.prototype.setNewRatio=function(){"use strict";this.ratio=this.getPhotoDimensions().x/this.imageDimensions.x;this.min_width=this.ratio*this._unscaledMinWidth;this.min_height=this.ratio*this._unscaledMinHeight;this.width=this.ratio*this._unscaledWidth;this.height=this.ratio*this._unscaledHeight;return this.ratio;};u.prototype.realignToPictureSize=function(){"use strict";var v=this.photo;if(!v)return;var w=this.getPhotoDimensions(),x=this.getPhotoPosition();[this.bg,this.wrapper].forEach(function(y){y.style.width=w.x+'px';y.style.height=w.y+'px';y.style.top=x.y+'px';y.style.left=x.x+'px';});};u.prototype.redraw=function(){"use strict";var v=[this.box.t,this.box.r,this.box.b,this.box.l],w=this.getPhotoDimensions();this.highlight.style.width=w.x+"px";this.highlight.style.height=w.y+"px";this.highlight.style.clip="rect("+v.join("px ")+"px)";this.viewport.style.top=this.box.t+"px";this.viewport.style.left=this.box.l+"px";this.viewport.style.height=(this.box.b-this.box.t)+"px";this.viewport.style.width=(this.box.r-this.box.l)+"px";};u.prototype.done=function(v){"use strict";this.freezeViewport=true;if(!v){[this.bg,this.wrapper].forEach(j.remove);if(this.create_target){j.remove(this.target);this.target=null;}else i.removeClass(this.target,'photocrop');}var w=Math.round(this.box.l*(1/this.ratio)),x=Math.round(this.box.t*(1/this.ratio)),y=Math.round(this.box.r*(1/this.ratio)),z=Math.round(this.box.b*(1/this.ratio));this.inform('done',v);return {x:Math.max(w,0),y:Math.max(x,0),width:y-Math.max(w,0),height:z-Math.max(x,0)};};u.prototype.mousedown=function(v){"use strict";if(this.freezeViewport)return;this.mouseTarget=v.getTarget();this._constraint.onMouseDown(n.getEventPosition(v));i.addClass(document.body,'draggingMode');return false;};u.prototype.mousemove=function(v){"use strict";if(!this.mouseTarget)return;this._constraint.onMouseMove(n.getEventPosition(v),this.mouseTarget!==this.viewport,this.mouseTarget.getAttribute('data-cropcorner'));this.redraw();return false;};u.prototype.mouseup=function(v){"use strict";this.mouseTarget=null;i.removeClass(document.body,'draggingMode');};e.exports=u;});
__d("PhotoTagger",["Arbiter","AsyncRequest","CSS","DOM","ErrorDialog","Event","FaceboxSourceConstants","Hovercard","Keys","Parent","PhotosConst","PhotosTaggingWaterfall","PhotosUtils","PhotoTagStore","Style","Vector","copyProperties","csx","getElementPosition","removeFromArray","userAction"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa){function ba(da,ea){return ((da%ea)+ea)%ea;}function ca(da){"use strict";this.viewer=da;this.version=da.getVersionConst();this.datasources={};this.photoData={};this.tagRects={};this.ajaxURIs={tagsInit:'/ajax/photos/photo/tags/tags_init.php',tagsAlbum:'/ajax/photos/photo/tags/tags_album.php',fetchDatasource:'/ajax/photos/photo/tags/fetch_datasource.php',tagAction:'/ajax/photo_tagging_ajax.php',tagWithAction:'/ajax/with_tagging_ajax.php'};this.recognizedUsers=[];this.addedSuggestions=[];this.featuredSuggestions=[];this.albumSuggestions=[];this.friendSuggestions=[];this.suggestionAlbum=-1;ca.instances[this.version]=this;}ca.prototype.initSnowlift=function(da,ea,fa){"use strict";this._init(da,ea,fa,this.viewer.container);};ca.prototype.initPermalink=function(da,ea,fa){"use strict";this._init(da,ea,fa,this.viewer.actionList);};ca.prototype._init=function(da,ea,fa,ga){"use strict";this.setupUserActionLogging();this.root=this.viewer.getRoot();this.tagger=da;this.tokenizer=ea;this._qn=null;this.typeahead=ea.getTypeahead();this.userId=fa;this.makeProfilePicMenuContainer=ga;this.faceboxes=[];this.tags=[];this.currentFacebox=null;this.revokedFaceboxes=[];this.requestFaceboxNextTag=false;this.clickState=j.find(this.root,'div.stageActions');this.newTagBox=j.find(this.clickState,'div.newTagBox');this.addTagLink=j.find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=j.find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.needAlbumSuggestionsFetch=true;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());this.updateFaceboxes();this.tagAccumulating=false;return this;};ca.prototype.setTagAccumulator=function(da){"use strict";this.tagAccumulating=da;};ca.prototype.setupUserActionLogging=function(){"use strict";this.ua=aa(this.viewer.getSourceString()).uai('init','tagging').add_event('init');};ca.prototype.logUserActionEvent=function(da){"use strict";this.ua.add_event(da);};ca.prototype.fetchTaggingSuggestions=function(da){"use strict";this.logUserActionEvent('sugg_fetch');new h().setURI(this.ajaxURIs.tagsInit).setData(da).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(fa){var ga=fa.getPayload();this.featuredSuggestions=ga.featuredTaggees;this.friendSuggestions=ga.friendTaggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_fetch_done');}.bind(this)).send();var ea=this.typeahead.subscribe('bootstrap',function(fa,ga){if(ga&&!ga.bootstrapping){if(this.taggingMode)this.updateWithSuggestions();this.typeahead.unsubscribe(ea);this.typeahead.subscribe('focus',function(){if(this.taggingMode)this.updateWithSuggestions();}.bind(this));this.typeahead.subscribe('click',function(){if(!this.taggingMode)this.updateWithSuggestions();}.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(ha,ia){if(this.taggingMode&&ia&&!ia.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));};ca.prototype.fetchAlbumTaggingSuggestions=function(){"use strict";this.logUserActionEvent('sugg_album_fetch');new h().setURI(this.ajaxURIs.tagsAlbum).setData({cachedAlbum:this.suggestionAlbum,photo:this.photoData.fbid}).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(da){this.needAlbumSuggestionsFetch=false;var ea=da.getPayload();if(ea.length===0)return;this.suggestionAlbum=ea.album;this.albumSuggestions=ea.taggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_album_fetch_done');}.bind(this)).send();};ca.prototype.resetAlbumTaggingSuggestions=function(){"use strict";this.needAlbumSuggestionsFetch=true;this.updateTypeaheadSuggestions();};ca.prototype.updateTypeaheadSuggestions=function(){"use strict";this.typeahead.getView().setSuggestions(this.addedSuggestions.concat(this.recognizedUsers,this.featuredSuggestions,this.needAlbumSuggestionsFetch?[]:this.albumSuggestions,this.friendSuggestions));};ca.prototype.saveClickPosition=function(da,ea){"use strict";var fa=v.getElementPosition(da),ga=v.getElementDimensions(da);this.clickPercentToPhoto=new v((ea.x-fa.x)/ga.x,(ea.y-fa.y)/ga.y);};ca.prototype.getCalculatedClickPosition=function(da){"use strict";var ea=v.getElementPosition(da),fa=v.getElementDimensions(da);if(fa.x===0||fa.y===0)return null;return new v(this.clickPercentToPhoto.x*fa.x+ea.x,this.clickPercentToPhoto.y*fa.y+ea.y,'document');};ca.prototype.repositionTagger=function(){"use strict";if(this.clickPercentToPhoto){var da=this.viewer.getImage(),ea=this.getCalculatedClickPosition(da);if(!ea)return;this.addTagFromClickPos(ea);}};ca.prototype.setupHandlers=function(){"use strict";this.handlers=[l.listen(this.clickState,'click',this.addTag.bind(this)),l.listen(this.addTagLink,'click',this.checkActions.bind(this)),l.listen(this.overlayActions,'click',this.checkActions.bind(this))];l.listen(document.documentElement,'keydown',function(event){if(!this.taggingMode)return;var da=l.getKeyCode(event);if(da===o.ESC){this.deactivateTagging();}else if(da===o.TAB)this.addNextTagFromFacebox(event.shiftKey?-1:1);}.bind(this));this.subscriptions=[g.subscribe(this.viewer.getEventString('PAGE'),this.restartTagging.bind(this)),g.subscribe(this.viewer.getEventString('DATA_CHANGE'),this.setPhotoData.bind(this)),g.subscribe(this.viewer.getEventString('EXTRA_DATA_CHANGE'),this.setExtraData.bind(this)),g.subscribe(this.viewer.getEventString('CLOSE'),this.deactivateTagging.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));};ca.prototype.updateWithSuggestions=function(da,ea){"use strict";var fa=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!fa.length)return;var ga=this.typeahead.getData().respond('',fa);for(var ha=0;ha<ga.length;ha++)ga[ha].index=-1000+ha;};ca.prototype.addSuggestion=function(da,ea){"use strict";var fa=ea.info&&ea.info.uid;if(fa){this.addedSuggestions.unshift(fa);this.updateTypeaheadSuggestions();}};ca.prototype.setQueueName=function(da){"use strict";this._qn=da;return this;};ca.prototype._sendWaterfallLogSignal=function(da){"use strict";r.sendSignal({qn:this._qn,source:this.viewer.getSourceString(),step:da,pid:this.photoData.pid});};ca.prototype._sendFaceboxSuggestionLogSignal=function(da,ea){"use strict";r.sendSignal({step:r.SHOW_SUGGEST,photo_owner:this.photoData.owner,tagee:da,is_first:true,source:ea});};ca.prototype._bumpQueueName=function(){"use strict";if(this._qn)this._qn+=1;};ca.prototype.activateTagging=function(){"use strict";this.logUserActionEvent('activate');g.inform('PhotoTagger.ACTIVATE_TAGGING');if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new h(this.ajaxURIs.fetchDatasource).setData({fbid:this.photoData.fbid,version:this.version}).send();if(this.needAlbumSuggestionsFetch)this.fetchAlbumTaggingSuggestions();};ca.prototype.restartTagging=function(){"use strict";this.hideNewTag();this.hideTagger();this.revokedFaceboxes=[];this.setCurrentFacebox(null);if(this.taggingMode){this.requestFaceboxNextTag=true;this.activateTagging();}};ca.prototype.getDataSource=function(){"use strict";return this.datasources[this.getDataSourceKey()];};ca.prototype.getDataSourceKey=function(){"use strict";if(this.photoData.ownertype=='user'&&!this.photoData.obj_id)return 'friends';return this.photoData.obj_id||this.photoData.owner;};ca.prototype.setDataSource=function(da){"use strict";if(this.typeahead.getData()!=da)this.typeahead.swapData(da);this.datasources[this.getDataSourceKey()]=da;};ca.prototype.dataSourceFetched=function(da){"use strict";this.taggingMode=true;i.addClass(this.root,'taggingMode');g.inform('PhotoTagger.ACTIVATED_TAGGING');this._bumpQueueName();this._sendWaterfallLogSignal(r.BEGIN);this.setDataSource(da);};ca.prototype.deactivateTagging=function(){"use strict";this.logUserActionEvent('deactivate');if(this.taggingMode===true)this._sendWaterfallLogSignal(r.FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();this.setCurrentFacebox(null);i.removeClass(this.root,'taggingMode');g.inform('PhotoTagger.DEACTIVATED_TAGGING');};ca.prototype.checkActions=function(event){"use strict";var da=event.getTarget();if(p.byClass(da,'fbPhotosPhotoActionsTag'))if(this.taggingMode){this.deactivateTagging();}else{this.activateTagging();this.addNextTagFromFacebox(1);}};ca.prototype.hideTagger=function(){"use strict";i.hide(this.tagger);this.clickPercentToPhoto=null;var da=j.scry(this.tagger,'input.textInput')[0];if(da)da.blur();};ca.prototype.showTagger=function(){"use strict";var da=j.find(this.tagger,'.typeaheadContainer'),ea=j.find(da,'.arrow .nub'),fa=y(da),ga=3;u.set(da,'margin-left',0);u.set(ea,'margin-left',0);i.show(this.tagger);if(fa.x<0){u.set(da,'margin-left',((-2*fa.x)+'px'));u.set(ea,'margin-left',(fa.x-ga)+'px');}setTimeout((function(){j.find(this.tagger,'input.textInput').focus();}).bind(this),0);this.hideNewTag();g.inform('reflow');};ca.prototype.showNewTag=function(da){"use strict";if(!this.newTagBox)return;j.setContent(j.find(this.newTagBox,'div.tagName'),j.create('span',null,da));i.show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);};ca.prototype.hideNewTag=function(){"use strict";if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}i.hide(this.newTagBox);};ca.prototype.getTaggerPositioningOrigin=function(){"use strict";return v.getElementPosition(this.clickState,'document');};ca.prototype.setClickPosAndFacebox=function(da){"use strict";var ea=this.viewer.getImage();this.saveClickPosition(ea,da);var fa=s.absoluteToNormalizedPosition(ea,da);this.setCurrentFacebox(this.findNearestFacebox(fa));};ca.prototype.addTagFromClickPos=function(da){"use strict";if(this.currentFacebox){this.addTagFromFaceboxDontSave(this.currentFacebox);}else{this.removeSuggestionFromTagger();i.removeClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');this.addTagFromPosition(da,this.TAG_BOX_SIZE);}};ca.prototype.addTag=function(event){"use strict";var da=event.getTarget(),ea=p.byClass(da,'fbPhotosPhotoButtons');if(!this.taggingMode||(ea&&da!==ea)||p.byClass(da,'fbPhotosPhotoActions')||p.byClass(da,'faceboxSuggestion')||p.byClass(da,'photoTagTypeahead'))return;var fa=v.getEventPosition(event);this.setClickPosAndFacebox(fa);this.addTagFromClickPos(fa);};ca.prototype._findNearest=function(da,ea){"use strict";var fa=Infinity,ga=null;da.forEach(function(ha){if(ha.rect.contains(ea)){var ia=ea.distanceTo(ha.rect.getCenter());if(ia<fa){fa=ia;ga=ha;}}});return ga;};ca.prototype.findNearestFacebox=function(da){"use strict";return this._findNearest(this.faceboxes,da);};ca.prototype.findNearestTag=function(da){"use strict";return this._findNearest(this.tags,da);};ca.prototype.addNextTagFromFacebox=function(da){"use strict";if(this.faceboxes.length===0)return;if(!this.currentFacebox){this.setCurrentFacebox(this.faceboxes[0]);}else{var ea=this.faceboxes.indexOf(this.currentFacebox),fa=ba(ea+da,this.faceboxes.length);if(fa===ea)return;this.setCurrentFacebox(this.faceboxes[fa]);}this.addTagFromFacebox(this.currentFacebox);};ca.prototype.addTagFromFaceboxDontSave=function(da){"use strict";i.addClass(da.node,'active');i.addClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');var ea=da.rect.getCenter(),fa=this.viewer.getImage(),ga=s.normalizedToAbsolutePosition(fa,ea),ha=(da.rect.w()/100)*v.getElementDimensions(fa).x;if(da.rect.w()>this.HUGE_FACE_THRESH&&da.rect.h()>this.HUGE_FACE_THRESH)ha*=this.HUGE_FACE_SHRINK_FACTOR;var ia=this.getFaceboxSuggestionFromFaceboxElem(da.node);if(ia){var ja=(this.version===q.VIEWER_PERMALINK)?m.PERMALINK_DISMISS:m.SNOWLIFT_DISMISS;this.addSuggestionToTagger(da,ia);this._sendFaceboxSuggestionLogSignal(ia.getAttribute('data-id'),ja);}else this.removeSuggestionFromTagger();this.addTagFromPosition(ga,ha);return ga;};ca.prototype.getFaceboxSuggestionFromFaceboxElem=function(da){"use strict";return j.scry(da,"._570u")[0];};ca.prototype.addSuggestionToTagger=function(da,ea){"use strict";this.removeSuggestionFromTagger();i.addClass(this.tagger,'suggestionActive');var fa=j.find(this.tagger,'.typeaheadContainer'),ga=ea.cloneNode(true);j.appendContent(fa,ga);this.setupFaceboxSuggestionHandlers(da,ga);};ca.prototype.removeSuggestionFromTagger=function(){"use strict";i.removeClass(this.tagger,'suggestionActive');var da=j.scry(this.tagger,'.faceboxSuggestion');da&&da.forEach(function(ea){j.remove(ea);});};ca.prototype.dismissFaceboxSuggestion=function(da,ea,fa,ga){"use strict";new h().setURI('/ajax/dismiss_tag_suggest.php').setMethod('POST').setData({facebox_logs:[{facebox:da,log_data:{photo_owner:fa,tagee:ea,is_first:true}}],closing_source:ga,closing_action:'no'}).setAllowCrossPageTransition(true).send();};ca.prototype.addTagFromFacebox=function(da){"use strict";var ea=this.addTagFromFaceboxDontSave(da),fa=this.viewer.getImage();this.saveClickPosition(fa,ea);};ca.prototype.addTagFromPosition=function(da,ea){"use strict";var fa=this.viewer.getImage(),ga=this.calcTaggerPosition(fa,da,ea);this.calcClickPoint(fa,da);if(!ga){this.hideTagger();return;}ga.setElementPosition(this.tagger);if(this.newTagBox){ga.setElementPosition(this.newTagBox);new v(ea,ea).setElementDimensions(this.newTagBox);}var ha=v.getElementPosition(fa),ia=v.getElementDimensions(fa),ja=this.typeahead.getView();if(da.y>ha.y+ia.y*3/4){i.addClass(this.tagger,'fbPhotoTaggerFlipped');ja.addTypeaheadFlip('fbPhotoTaggerFlipped');if(da.x>ha.x+ia.x*1/2){this.flipRules('fbPhotoTaggerRight','fbPhotoTaggerLeft',ja);}else this.flipRules('fbPhotoTaggerLeft','fbPhotoTaggerRight',ja);}else{i.removeClass(this.tagger,'fbPhotoTaggerFlipped');i.removeClass(this.tagger,'fbPhotoTaggerLeft');i.removeClass(this.tagger,'fbPhotoTaggerRight');ja.removeTypeaheadFlip('fbPhotoTaggerFlipped');ja.removeTypeaheadFlip('fbPhotoTaggerLeft');ja.removeTypeaheadFlip('fbPhotoTaggerRight');}this.showTagger();if(this.taggingMode){this._sendWaterfallLogSignal(r.TAG_FACE);}else this._sendWaterfallLogSignal(r.HOVER_TAG_FACE);};ca.prototype.flipRules=function(da,ea,fa){"use strict";i.addClass(this.tagger,da);i.removeClass(this.tagger,ea);fa.addTypeaheadFlip(da);fa.removeTypeaheadFlip(ea);};ca.prototype.calcTaggerPosition=function(da,ea,fa,ga){"use strict";ga=ga||fa;var ha=v.getElementPosition(da),ia=v.getElementDimensions(da),ja=new v(fa/2,ga/2),ka=ea.sub(ha);for(var la in {x:1,y:1}){if(ea[la]<ha[la]||ea[la]>ha[la]+ia[la])return null;var ma=la==='x'?fa:ga;if(ka[la]<(ma/2)){ja[la]=ka[la];}else if(ia[la]<ka[la]+(ma/2))ja[la]=ma-(ia[la]-ka[la]);}var na=3,oa=j.find(this.tagger,'.faceBox');u.set(oa,'width',(fa-na*2)+'px');u.set(oa,'height',(ga-na*2)+'px');var pa=ea.sub(this.getTaggerPositioningOrigin());return pa.sub(ja.x,ja.y);};ca.prototype.calcClickPoint=function(da,ea){"use strict";var fa=v.getElementDimensions(da),ga=v.getElementPosition(da),ha=ea.sub(ga);this.clickPoint={x:ha.x/fa.x,y:ha.y/fa.y};};ca.prototype.saveTag=function(da,ea,fa){"use strict";var ga=this.getTaggingData('add',ea.isFreeform()?'':ea.getValue(),ea.getText(),fa);ga.x=this.clickPoint.x*100;ga.y=this.clickPoint.y*100;ga.from_facebox=!!this.currentFacebox;ga.tagging_mode=!!this.taggingMode;this.logUserActionEvent('save');if(this.tagAccumulating){t.getInstance().storeTagWithOptions(this.photoData.fbid,ga.subject,ga.x,ga.y,ga);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(ga).setAllowCrossPageTransition(true).setHandler(this.tagsChangeHandler.bind(this)).setErrorHandler(this.checkError.bind(this,ea)).send();var ha=(this.userId===ga.subject);if(ha){var ia=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ia.length===1){var ja=ia[0];i.removeClass(ja,'hide');}}this.showNewTag(ea.getText());this.hideTagger();var ka=this.currentFacebox;if(ka){if(this.taggingMode)this.addNextTagFromFacebox(1);this.removeFacebox(ka);}g.inform('PhotoTagger.SAVE_TAG',{photo_fbid:this.photoData.fbid,self_tag:ha});};ca.prototype.getTaggingData=function(da,ea,fa,ga){"use strict";return {cs_ver:this.version,pid:this.photoData.pid,fbid:this.photoData.fbid,id:this.photoData.owner,subject:ea,name:fa,action:da,source:ga?ga:this.viewer.getSourceString(),qn:this._qn,position:this.getPosition(),slsource:this.viewer.getViewerSource(),slset:this.viewer.getViewerSet()};};ca.prototype.getPosition=function(){"use strict";return this.viewer.getPosition();};ca.prototype.tagsChangeHandler=function(da){"use strict";this.logUserActionEvent('save_done');};ca.prototype.checkError=function(da,ea){"use strict";if(ea.getPayload()&&ea.getPayload().clear_tag){da.already_untagged=true;this.tokenizer.removeToken(da);}k.showAsyncError(ea);};ca.prototype.removeTag=function(da,ea,fa){"use strict";if(ea.already_untagged)return;var ga='remove';if(j.scry(ea.element,'a.pending')[0])ga='retract';if(ea.blockUser)ga='remove_block';this.logUserActionEvent('save');if(this.tagAccumulating){if(ea.isFreeform()){t.getInstance().removeTextTag(this.photoData.fbid,ea.getInfo().text);}else t.getInstance().removeTag(this.photoData.fbid,ea.getInfo().uid);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData(ga,ea.isFreeform()?'':ea.getInfo().uid,ea.getInfo().text)).setHandler(function(ja){this.tagsChangeHandler(ja);fa&&fa();}.bind(this)).setAllowCrossPageTransition(true).send();if(this.userId===parseInt(ea.getValue(),10)&&this.userId!==this.viewer.getCurrentPhotoInfo().owner){var ha=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ha.length===1){var ia=ha[0];i.addClass(ia,'hide');}g.inform('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION');}};ca.prototype.removeTagByID=function(da,ea,fa){"use strict";var ga=this.tokenizer.tokens;for(var ha=0;ha<ga.length;ha++)if(ga[ha].info.uid==ea)return this.removeTag(null,ga[ha],fa);};ca.prototype.removeTagByIDFromHovercardLink=function(da,ea,fa){"use strict";this.removeTagByID(da,ea,function(){if(n.contains(fa))n.hide(true);});};ca.prototype.removeWithTag=function(da,ea){"use strict";new h().setURI(this.ajaxURIs.tagWithAction).setMethod('POST').setData({action:'remove_with',taggee:ea,tag:da,version:this.version,fbid:this.photoData.fbid}).setHandler(function(fa){this.tagsChangeHandler(fa);if(window.Hovercard)window.Hovercard.hide(true);}.bind(this)).setAllowCrossPageTransition(true).send();};ca.prototype.setPhotoData=function(da,ea){"use strict";this.clickPercentToPhoto=null;this.photoData=ea;return this;};ca.prototype.setExtraData=function(da,ea){"use strict";this.tagRects=ea.tagRects;this.updateFaceboxes();if(ea.initialFaceboxID!==null&&this.faceboxes.length!==0){var fa=this.getFacebox(ea.initialFaceboxID);if(fa!==null){var ga=this.faceboxes.indexOf(fa);ga=ba(ga-1,this.faceboxes.length);this.setCurrentFacebox(this.faceboxes[ga]);}}if(ea.openTag)setTimeout((function(){this.activateTagging();this.addNextTagFromFacebox(1);}).bind(this),0);return this;};ca.prototype.markTagAsSpam=function(da,ea){"use strict";new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData('mark_as_spam',ea,null)).send();};ca.prototype.removeFacebox=function(da){"use strict";if(da===null)return;this.revokedFaceboxes.push(da.rect.getCenter());z(this.faceboxes,da);j.remove(da.node);if(da===this.currentFacebox)this.setCurrentFacebox(null);};ca.prototype.setCurrentFacebox=function(da){"use strict";if(this.currentFacebox)i.removeClass(this.currentFacebox.node,'active');this.currentFacebox=da;if(da){this.recognizedUsers=JSON.parse(da.node.getAttribute('data-recognizeduids'));this.updateTypeaheadSuggestions();}};ca.prototype.updateRevokedFaceboxes=function(){"use strict";this.revokedFaceboxes=this.revokedFaceboxes.filter(function(da){for(var ea=0;ea<this.faceboxes.length;++ea){var fa=this.faceboxes[ea],ga=da.distanceTo(fa.rect.getCenter());if(ga<this.EPSILON)return true;}return false;}.bind(this));this.revokedFaceboxes.forEach(function(da){var ea=this.findNearestFacebox(da);z(this.faceboxes,ea);j.remove(ea.node);}.bind(this));};ca.prototype.updateFaceboxes=function(){"use strict";this.faceboxes=[];this.tags=[];for(var da in this.tagRects){var ea;if(s.isFacebox(da)){ea=this.faceboxes;}else if(s.isTag(da))ea=this.tags;if(ea){var fa='container';if(this.version===q.VIEWER_PERMALINK)fa='root';ea.push({node:j.find(this.viewer[fa],'#'+da),id:da,rect:this.tagRects[da]});}}this.updateRevokedFaceboxes();this.faceboxes.sort(function(ha,ia){return ha.rect.getCenter().x-ia.rect.getCenter().x;});if(this.currentFacebox){var ga=this.currentFacebox.rect.getCenter();this.setCurrentFacebox(this.findNearestFacebox(ga));i.addClass(this.currentFacebox.node,'active');}if(this.requestFaceboxNextTag){this.addNextTagFromFacebox(1);this.requestFaceboxNextTag=false;}};ca.prototype.getFacebox=function(da){"use strict";for(var ea=0;ea<this.faceboxes.length;++ea)if(this.faceboxes[ea].id===da)return this.faceboxes[ea];return null;};ca.prototype.setupFaceboxSuggestionHandlers=function(da,ea){"use strict";var fa=j.find(ea,"a._570w"),ga=j.find(ea,"a._570x");this.handlers.push(l.listen(fa,'click',function(ha){var ia=(this.version===q.VIEWER_PERMALINK)?m.PERMALINK_DISMISS:m.SNOWLIFT_DISMISS;this.dismissFaceboxSuggestion(da.id.replace('face:',''),ea.getAttribute('data-id'),this.photoData.owner,ia);this.removeSuggestionFromTagger();this.hideTagger();j.remove(this.getFaceboxSuggestionFromFaceboxElem(da.node));}.bind(this)),l.listen(ga,'click',function(ha){var ia={uid:ea.getAttribute('data-id'),text:ea.getAttribute('data-text')},ja=this.tokenizer.createToken(ia),ka=(this.version===q.VIEWER_PERMALINK)?m.PERMALINK_SUGGEST:m.SNOWLIFT_SUGGEST;this.saveTag(null,ja,ka);}.bind(this)));};ca.getInstance=function(da){"use strict";return ca.instances[da];};ca.resetAlbumTaggingSuggestions=function(da){"use strict";var ea=ca.getInstance(da);ea&&ea.resetAlbumTaggingSuggestions();};w(ca,{instances:{}});w(ca.prototype,{TAG_BOX_SIZE:100,EPSILON:.0025,HUGE_FACE_THRESH:90,HUGE_FACE_SHRINK_FACTOR:.6,elemNames:{6:{addTagLink:'div.fbPhotosPhotoOwnerButtons',overlayActions:'div.snowliftOverlayBar'}}});e.exports=ca;});
__d("PhotoPermalink",["Arbiter","Assert","AsyncRequest","Bootloader","CSS","DOM","Event","KeyEventController","Keys","PageTransitions","Parent","PhotoPermalinkURI","PhotosConst","PhotoSessionLog","PhotoStreamCache","PhotosUtils","PhotoTagger","PhotoViewer","Style","Vector","$","copyProperties","createArrayFrom","emptyFunction","ge","goURI"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa){for(var ga in x)if(x.hasOwnProperty(ga))ia[ga]=x[ga];var ha=x===null?null:x.prototype;ia.prototype=Object.create(ha);ia.prototype.constructor=ia;ia.__superConstructor__=x;function ia(){"use strict";x.call(this);this.encodingMode=false;this._uriStack=[];this.replaceUrl=false;this.payloadInitialized=false;}ia.prototype.init=function(){"use strict";this.stream=new u();this.stream.init(s.VIEWER_PERMALINK,'PhotoViewerPagelet','pagelet_photo_viewer');this.reset();this.root=aa('fbPhotoPageContainer');this.header=aa('fbPhotoPageHeader');this.stageWrapper=l.find(this.root,'.stageContainer');this.videoStage=l.find(this.stageWrapper,'div.videoStage');this.buttonActions=l.find(this.root,'div.stageButtons');this.viewLargerLink=l.scry(this.root,'a.fbPhotoViewLarger').pop();this.feedback=ea('fbPhotoPageFeedback');this.image=ea('fbPhotoImage');this.errorBox=ea('fbPhotoPageError');this.actionList=ea('fbPhotoPageActions');this.stageActions=l.find(this.root,'div.stageActions');this.showingTypeaheadSuggestions=false;this.loadingStates={image:false,html:false};this.unhiliteTimer=null;this.source=null;this.imageLoadListener=m.listen(this.image,'load',this.adjustForNewData.bind(this));this.pageHandlers=[m.listen(this.root,'mouseout',this.mouseOutListener.bind(this)),m.listen(this.root,'mousemove',this.mouseMoveListener.bind(this)),m.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),m.listen(this.buttonActions,'click',this.buttonListener.bind(this)),m.listen(this.actionList,'click',this.rotateListener.bind(this)),m.listen(this.feedback,'click',function(event){var ja=event.getTarget();if(q.byClass(ja,'like_link')||(q.byClass(ja,'UFILikeLink')&&q.byClass(ja,'UIActionLinks')))k.toggleClass(l.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this))];p.registerHandler(this.transitionHandler.bind(this));n.registerKey('LEFT',this.goNav.bind(this));n.registerKey('RIGHT',this.goNav.bind(this));t.initLogging(t.PERMALINK);g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));this.adjustForNewData();};ia.prototype.getEventPrefix=function(){"use strict";return 'PhotoPermalink';};ia.prototype.getSourceString=function(){"use strict";return 'permalink';};ia.prototype.getViewerSource=function(){"use strict";return this.source;};ia.prototype.getViewerSet=function(){"use strict";return this.stream.getPhotoSet();};ia.prototype.getVersionConst=function(){"use strict";return s.VIEWER_PERMALINK;};ia.prototype.saveTagsFromPayload=function(ja){"use strict";this.storeFromData(ja);if('data' in ja&&this.stream.getCursor() in ja.data)this.swapData();};ia.prototype.goNav=function(event){"use strict";var ja=m.getKeyCode(event)||event.getTarget(),ka=event.type==='click'&&q.byClass(ja,'stageWrapper')&&!q.byClass(ja,'tagBoxPending')&&!q.byClass(ja,'tagBoxPendingResponse')&&!q.byClass(ja,'uiButtonGroup');if(ka&&k.hasClass(this.root,'taggingMode'))return false;if(ja==o.LEFT){this.page(-1);}else if(ja==o.RIGHT||ka)this.page(1);return false;};ia.prototype.pagerClick=function(ja){"use strict";if(ja=='prev'){this.page(-1);}else if(ja=='next')this.page(1);return false;};ia.prototype.setLoadingState=function(ja,ka){"use strict";switch(ja){case ia.STATE_IMAGE_DATA:this.loadingStates[ja]=ka;k.conditionClass(this.root,'imageLoading',ka);break;case ia.STATE_HTML:this.loadingStates[ja]=ka;k.conditionClass(this.root,'dataLoading',ka);break;}};ia.prototype.checkState=function(ja){"use strict";if(ja!=ia.STATE_ERROR&&!this.loadingStates[ja])return;switch(ja){case ia.STATE_IMAGE_DATA:var ka=this.stream.getCurrentImageData();if(ka){if(ka.url){this.switchImage(ka.url,true);}else if(ka.video)this.switchVideo(ka.video,true);this.setLoadingState(ja,false);}break;case ia.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(ja,false);}break;default:if(this.stream.errorInCurrent()){k.hide(this.image);k.show(this.errorBox);}break;}};ia.prototype.reHilitePendingTag=function(){"use strict";var ja=ea(this.hilitedTag);if(ja&&k.hasClass(ja,'showPendingTagName'))return;var ka=l.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(ka)this.switchHilitedTags(ka.id);};ia.prototype.setReachedLeftEnd=function(){"use strict";this.stream.setReachedLeftEnd();};ia.prototype.setReachedRightEnd=function(){"use strict";this.stream.setReachedRightEnd();};ia.prototype.isPagingAllowed=function(ja){"use strict";return this.stream.isValidMovement(ja)&&!k.hasClass(this.root,'croppingMode');};ia.prototype.page=function(ja,ka){"use strict";if(!this.isPagingAllowed(ja)||!this.stream.nonCircularPhotoSetCanPage(ja))return;this.unhiliteAllTags();var la=this.getVideoOnStage();if(la)this.switchVideo(la,false);this.recacheData();this.stream.moveCursor(ja);k.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(ia.STATE_HTML,true);k.show(this.errorBox);return;}var ma=this.stream.getCurrentImageData();if(ma){if(ma.url){this.switchImage(ma.url,true);if(this.viewLargerLink)this.viewLargerLink.setAttribute('href',ma.info.permalink);}else if(ma.video)this.switchVideo(ma.video,true);if(!ka){this.replaceUrl=true;fa(ma.info.permalink);}}else{this.waitForLoadCount++;this.setLoadingState(ia.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(ia.STATE_HTML,true);g.inform('PhotoPermalink.PAGE');};ia.prototype.transitionHandler=function(ja){"use strict";if(!r.isValid(ja))return false;if(ja.getQueryData().makeprofile&&ja.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){j.loadModules(["PhotoPermalinkCropper"],function(oa){oa.start();});p.transitionComplete();return true;}var ka=ja.getQualifiedURI().toString();if(!ja.protocol)ka=ka.replace(/^file:\/\//,"");if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(ka);p.transitionComplete();return true;}var la=this._uriStack.length;if(la>=2&&this._uriStack[la-2]===ka)this._uriStack.pop();var ma=this.stream.getCursorForURI(ja.getUnqualifiedURI().toString());if(ma){var na=this.stream.getRelativeMovement(ma);this.page(na,true);p.transitionComplete();return true;}return false;};ia.prototype.recacheData=function(ja){"use strict";if(!this.loadingStates.html){var ka=this.stream.getCurrentHtml();for(var la in ka){var ma=ea(la);if(ma)ka[la]=ca(ma.childNodes);if(ja!==true&&la!=='fbPhotoPageHeader')l.empty(aa(la));}}};ia.prototype.getCurrentPhotoInfo=function(){"use strict";var ja=this.stream.getCurrentImageData();return ja&&ja.info;};ia.prototype.getVideoOnStage=function(){"use strict";var ja=this.stream.getCurrentImageData();return ja&&ja.video;};ia.prototype.switchImage=function(ja,ka){"use strict";k.hide(this.image);k.hide(this.errorBox);var la=this.stream&&this.stream.getCurrentImageData();if(la)t.addPhotoView(la.info);var ma=l.create('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:ja});l.replace(this.image,ma);this.image=ma;if(this.imageLoadListener)this.imageLoadListener.remove();this.imageLoadListener=m.listen(this.image,'load',this.adjustForNewData.bind(this));if(ka)this.stream.preloadImages();};ia.prototype.switchVideo=function(ja,ka){"use strict";var la='swf_'+ja;if(ka){k.addClass(this.stageWrapper,'showVideo');this.videoStage.id=ja;if(window[la]&&!ea(la))window[la].write(ja);}else{this.videoStage.id='fbPageVideoStage';window[la].addVariable('video_autoplay',0);l.empty(this.videoStage);k.removeClass(this.stageWrapper,'showVideo');}};ia.prototype.swapData=function(){"use strict";if(this.dataLoadTimer){this.setLoadingState(ia.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var ja,ka=this.stream.getCurrentHtml();if(ka){for(var la in ka){ja=ea(la);ja&&l.setContent(ja,ka[la]);}g.inform('PhotoPermalink.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData()){g.inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);var ma=this.stream.getCurrentExtraData();if(ma&&ma.source!==undefined){this.source=ma.source;t.setSource(this.source);}}this.setLoadingState(ia.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();};ia.prototype.clearTimer=function(ja){"use strict";this.dataLoadTimer=false;ja&&this.swapData();};ia.prototype.adjustForNewData=function(){"use strict";if(!this.image)return;var ja=l.scry(this.stageWrapper,'div.tagsWrapper')[0],ka=z.getElementDimensions(this.image);if(ja){y.set(ja,'width',ka.x+'px');y.set(ja,'height',ka.y+'px');}};ia.prototype.fetchInitBucket=function(ja){"use strict";if(!this.stream.isLoaded())return;this.stream.fetch(ja,true);};ia.prototype.addPhotoFbids=function(ja,ka,la){"use strict";var ma=this.stream.getCursor()===null;this.stream.attachToFbidsList(ja,ka,la);if(la&&ma)this.page(0);};ia.prototype.attachTagger=function(ja){"use strict";l.appendContent(this.stageActions,ja);};ia.prototype.storeFromData=function(ja){"use strict";var ka=this.stream.storeToCache(ja);if('init' in ja){t.setPhotoSet(this.stream.getPhotoSet());t.setLogFbids(true);t.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in ka){this.checkState(ia.STATE_ERROR);return;}if('image' in ka)this.checkState(ia.STATE_IMAGE_DATA);if('data' in ka)this.checkState(ia.STATE_HTML);if(!this.payloadInitialized&&this.stream.getCurrentExtraData()){this.payloadInitialized=true;g.inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);}};ia.prototype.handleServerError=function(ja,ka){"use strict";l.setContent(this.errorBox,ja);this.storeFromData(ka);};ia.prototype.updateTotalCount=function(ja,ka,la){"use strict";var ma=ea('fbPhotoPagePositionAndCount');ma&&l.setContent(ma,la);this.stream.setTotalCount(ja);this.stream.setFirstCursorIndex(ka);};ia.prototype.buttonListener=function(event){"use strict";var ja=event.getTarget();if(q.byClass(ja,'likeButton')){var ka=l.scry(this.feedback,'button.like_link')[0];if(!ka)ka=l.scry(this.feedback,'a.UFILikeLink')[0];ka&&ka.click();}else if(q.byClass(ja,'commentButton')){var la=l.scry(this.feedback,'div.commentBox textarea')[0];if(!la)la=l.scry(this.feedback,'li.UFIAddComment textarea')[0];if(la){la.focus();this.root.scrollTop=this.root.scrollHeight;}}};ia.prototype.rotateListener=function(event){"use strict";var ja=event.getTarget();if(q.byClass(ja,'rotateRight')){this.rotate('right');}else if(q.byClass(ja,'rotateLeft'))this.rotate('left');};ia.prototype.stageClickListener=function(event){"use strict";var ja=event.getTarget(),ka=k.hasClass(ja,'faceBox'),la=(q.byClass(ja,'fbPhotoTagApprovalBox')||q.byClass(ja,'faceboxSuggestion')||q.byClass(ja,'videoStage')||q.byClass(ja,'tag')||q.byClass(ja,'typeaheadWrapper')||q.byClass(ja,'photoTagTypeahead')||q.byClass(ja,'fbPhotoViewLarger')||ka);if(ka){if(!this.showingTypeaheadSuggestions){var ma=this.getTagger();ma.updateWithSuggestions();setTimeout((function(){l.find(ma.tagger,'input.textInput').focus();}).bind(this),0);}this.showingTypeaheadSuggestions=!this.showingTypeaheadSuggestions;}if(la){return true;}else this.goNav(event);};ia.prototype.rotate=function(ja){"use strict";var ka=this.stream.getCursor();if(this.getVideoOnStage()){var la=(ja=='left')?270:90;h.isTruthy(this.videoRotateURI,"Video rotate URI not set.");j.loadModules(["VideoRotate"],function(na){new na(ka,this.videoRotateURI).motionRotate(la);}.bind(this));return;}var ma=ba({fbid:ka,opaquecursor:this.stream.getOpaqueCursor(ka),cs_ver:s.VIEWER_PERMALINK},this.stream.getPhotoSetQuery());ma[ja]=1;this.setLoadingState(ia.STATE_IMAGE_DATA,true);k.hide(this.image);new i('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(ma).setFinallyHandler(this.rotateComplete.bind(this,ka)).send();};ia.prototype.rotateComplete=function(ja,ka){"use strict";if(ja==this.stream.getCursor()){this.setLoadingState(ia.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}};ia.prototype.mouseOutListener=function(event){"use strict";var ja=event.getTarget(),ka=event.getRelatedTarget(),la=q.byClass(ja,'stageActions'),ma=q.byClass(ja,'stageWrapper'),na=q.byClass(ka,'stageActions'),oa=q.byClass(ka,'stageWrapper'),pa=q.byClass(ka,'uiContextualLayer'),qa=(!oa&&!pa&&(ma&&!na)||(la&&!oa));if(qa)this.unhiliteAllTags(true);};ia.prototype.mouseMoveListener=function(event){"use strict";var ja=event.getTarget(),ka=(q.byClass(ja,'faceboxSuggestion')||q.byClass(ja,'tagPointer')||q.byClass(ja,'typeaheadWrapper')||q.byClass(ja,'photoTagTypeahead')||q.byClass(ja,'arrow'));if(!q.byClass(ja,'stageActions')&&!q.byClass(ja,'stageWrapper')||ka)return;this.hiliteTagsOnMouseMove(event);};ia.prototype.unhiliteAllTags=function(ja,event){"use strict";l.scry(this.stageWrapper,'div.tagsWrapper div.hover').forEach(function(la){if(ja&&k.hasClass(la,'tagBoxPending'))return;k.removeClass(la,'hover');});if(ja)return;l.scry(this.stageWrapper,'div.tagsWrapper div.otherActive').forEach(function(la){k.removeClass(la,'otherActive');});if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;this.showingTypeaheadSuggestions=false;if(!k.hasClass(this.root,'taggingMode')){var ka=this.getTagger();if(ka){ka.hideTagger();ka.setCurrentFacebox(null);}}};ia.prototype.getTagger=function(){"use strict";return w.getInstance(s.VIEWER_PERMALINK);};ia.prototype.switchHilitedTags=function(ja,ka){"use strict";this.unhiliteAllTags();this.hiliteAllBoxes();var la=ea(ja);if(la){this.hilitedTag=ja;if(!k.hasClass(this.root,'taggingMode')&&v.isFacebox(this.hilitedTag)){var ma=this.getTagger();if(ma){k.addClass(la,'hover');var na=ma.getFacebox(ja);ma.setCurrentFacebox(na);if(na)ma.addTagFromFacebox(na);}}else k.addClass(la,'hover');if(k.hasClass(la,'tagBoxPending')&&!k.hasClass(la,'showPendingTagName')&&ka===true){l.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').forEach(function(oa){k.removeClass(oa,'showPendingTagName');});k.addClass(la,'showPendingTagName');}}};ia.prototype.hiliteTagsOnMouseMove=function(event){"use strict";if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var ja=event.getTarget();if(q.byClass(ja,'fbPhotoPageTagApproval')||q.byClass(ja,'tagPointer'))return;var ka=q.byClass(ja,'tagBoxPending'),la=false;if(this.hilitedTag){var ma=ea(this.hilitedTag);la=ma&&k.hasClass(ma,'tagBoxPending');}var na=((!this.hilitedTag&&ka)||(!la&&ka));if(na){this.switchHilitedTags(ka.id);return;}if(ka&&(ka.id==this.hilitedTag))return;var oa=250,pa=v.absoluteToNormalizedPosition(this.image,z.getEventPosition(event)),qa=v.getNearestBox(this.stream.getCurrentExtraData().tagRects,pa);if(!qa){if(!la){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var ra=null;if(la){var sa={};sa[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];ra=v.getNearestBox(sa,pa);}if(ra!==null&&la)return;if(this.hilitedTag!=qa)if(la){this.unhiliteTimer=setTimeout(this.unhiliteAllTags.bind(this,false,event),oa);}else this.switchHilitedTags(qa);};ia.prototype.updateTagBox=function(ja,ka){"use strict";this.unhiliteAllTags();var la=ea(ja);if(!la)return;k.addClass(la,'tagBox');k.addClass(la,'tagBoxPendingResponse');k.removeClass(la,'tagBoxPending');k.hide(l.find(la,'span.tagForm'));if(ka){k.show(l.find(la,'span.tagApproved'));}else k.show(l.find(la,'span.tagIgnored'));};ia.prototype.reset=function(){"use strict";while(this.pageHandlers&&this.pageHandlers.length)this.pageHandlers.pop().remove();if(this.imageLoadListener){this.imageLoadListener.remove();this.imageLoadListener=null;}n.getInstance().resetHandlers();};ia.prototype.onHiliteTag=function(ja,ka){"use strict";if(ka.version!=s.VIEWER_PERMALINK)return;var la=ka.tag;if(la){this.switchHilitedTags(la,true);}else this.unhiliteAllTags();};ia.prototype.onUpdateTagBox=function(ja,ka){"use strict";if(ka.version==s.VIEWER_PERMALINK)this.updateTagBox(ka.id,ka.approve);};ia.prototype.disableAutoRefresh=function(){"use strict";clearTimeout(this.timerId);};ia.prototype.isInVideoEncodingMode=function(){"use strict";return this.encodingMode;};ia.prototype.enableAutoRefresh=function(ja){"use strict";this.encodingMode=true;this.timerId=setTimeout(function(){window.location.reload();},ja);};ia.prototype.setHasLocation=function(ja){"use strict";k.conditionClass(this.root,'hasLocation',ja);};ia.getInstance=function(){"use strict";if(!ia._instance)ia._instance=new ia();return ia._instance;};ia.addPhotoFbids=function(ja,ka,la){"use strict";ia.getInstance().addPhotoFbids(ja,ka,la);};ia.setReachedLeftEnd=function(){"use strict";ia.getInstance().setReachedLeftEnd();};ia.setReachedRightEnd=function(){"use strict";ia.getInstance().setReachedRightEnd();};ia.attachTagger=function(ja){"use strict";ia.getInstance().attachTagger(ja);};ia.disableAjaxPipeForVideo=function(){"use strict";var ja=ia.getInstance();if(ja.stream)ja.stream.setUseAjaxPipe(false);};ia.init=function(){"use strict";ia.getInstance().init();};ia.recacheData=function(ja){"use strict";ia.getInstance().recacheData(ja);};ia.saveTagsFromPayload=function(ja){"use strict";ia.getInstance().saveTagsFromPayload(ja);};ia.saveTagsFromPayloadDelayed=function(ja){"use strict";setTimeout(ia.saveTagsFromPayload.bind(null,ja),2000);};ia.handleServerError=function(ja,ka){"use strict";ia.getInstance().handleServerError(ja,ka);};ia.setHasLocation=function(ja){"use strict";ia.getInstance().setHasLocation(ja);};ia.storeFromData=function(ja){"use strict";ia.getInstance().storeFromData(ja);};ia.swapData=function(){"use strict";ia.getInstance().swapData();};ia.updateTotalCount=function(ja,ka,la){"use strict";ia.getInstance().updateTotalCount(ja,ka,la);};ia.isInVideoEncodingMode=function(){"use strict";return ia.getInstance().isInVideoEncodingMode();};ia.disableAutoRefresh=function(){"use strict";ia.getInstance().disableAutoRefresh();};ia.enableAutoRefresh=function(ja){"use strict";ia.getInstance().enableAutoRefresh(ja);};ia.setVideoRotateURI=function(ja){"use strict";ia.getInstance().videoRotateURI=ja;};ba(ia,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,_instance:null,touchMarkup:da});e.exports=ia;});
__d("PhotoPermalinkTagger",["Arbiter","Event","PhotoPermalink","PhotoTagger","$","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k,l){for(var m in j)if(j.hasOwnProperty(m))o[m]=j[m];var n=j===null?null:j.prototype;o.prototype=Object.create(n);o.prototype.constructor=o;o.__superConstructor__=j;function o(p){"use strict";j.call(this,i.getInstance(),true);this.photoData=p;}o.prototype.setupHandlers=function(){"use strict";var p=k('imagestage'),q=k('fbPhotoPageTagBoxes');this.handlers=[h.listen(this.clickState,'click',this.addTag.bind(this)),h.listen(p,'click',this.addTag.bind(this)),h.listen(q,'click',this.addTag.bind(this)),h.listen(this.addTagLink,'click',this.checkActions.bind(this)),h.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[g.subscribe('PhotoPermalink.PAGE',this.restartTagging.bind(this)),g.subscribe('PhotoPermalink.DATA_CHANGE',this.setPhotoData.bind(this)),g.subscribe('PhotoPermalink.EXTRA_DATA_CHANGE',this.setExtraData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));};o.prototype.setDataForTokenizer=function(){"use strict";this.tokenizer.setup(null,this.photoData);return this;};l(o.prototype,{elemNames:{0:{addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons'}}});e.exports=o;});
__d("legacy:PhotoPermalinkTagger",["PhotoPermalinkTagger"],function(a,b,c,d){a.PhotoPermalinkTagger=b('PhotoPermalinkTagger');},3);
__d("XProfilePhotoActionLogControllerURIBuilder",["XControllerURIBuilder"],function(a,b,c,d,e,f,g){e.exports=g.create("\/profile_photo\/logger\/",{event:{type:"Enum",required:true},source:{type:"Enum",required:true},method:{type:"Enum",required:true}});});
__d("ProfilePhotoActionLogger",["AsyncSignal","XProfilePhotoActionLogControllerURIBuilder"],function(a,b,c,d,e,f,g,h){var i={EVENT_SELECT_METHOD:'select_method',SOURCE_TIMELINE:'timeline',SOURCE_NUX:'nux',METHOD_UPLOAD:'upload',log:function(j,k,l){new g((new h()).setEnum('event',j).setEnum('source',k).setEnum('method',l).getURI().toString()).send();}};e.exports=i;});
__d("ProfilePictureFlowLogging",["Arbiter","BanzaiLogger","Event","Parent","ProfilePhotoActionLogger","Run","TimelineProfilePicConfig","TimelineProfilePictureLoggerEnums","tidyEvent"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=m.loading,q=m.success,r='data-action-type',s,t,u;function v(){u&&u.unsubscribe();u=null;}var w={action:n.actions,step:n.steps,log:function(x,y,z){t=y||t;if(!t)return;s=z||s;var aa=x||w.step.INIT;h.log('TimelineProfilePictureActionLoggerConfig',{action_type:s,profile_id:t,step_type:aa});if(s==w.action.UPLOAD&&aa==w.step.INIT)k.log(k.EVENT_SELECT_METHOD,k.SOURCE_TIMELINE,k.METHOD_UPLOAD);if(x==='success')s=null;},init:function(x,y){if(!u){u=g.subscribe([p,q],function(z){w.log(z===p?n.steps.loading:n.steps.success,y);});l.onLeave(v);}o(i.listen(x,'click',function(z){var aa=j.byAttribute(z.getTarget(),r);if(!aa)return;s=aa.getAttribute(r);w.log(null,y);}));},initMenuItems:function(x,y,z){var aa=y.getFileForm();w.init(x.getRoot(),z);o([aa.subscribe('submit',function(){w.log(w.step.LOADING);}),aa.subscribe('success',function(){w.log(w.step.SUCCESS);}),aa.subscribe('fail',function(){w.log(w.step.FAIL);})]);}};e.exports=w;});
__d("PhotoPermalinkCropper",["Arbiter","CSS","Dialog","DOM","Event","Form","Keys","Photocrop2","PhotoPermalink","ProfilePicRequestCreator","ProfilePictureFlowLogging","copyProperties","tx"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t={initialize:function(u){this.clickHandlers=[];if(this.photocrop)this.destroy(false);this.photoPermalink=o.getInstance();this.root=this.photoPermalink.getRoot();this.options=u||{};this.registerClickHandler();this.registerEscapeKeyHandler();g.subscribe('PhotoPermalink.PAGE',function(){this.registerClickHandler();this.registerEscapeKeyHandler();this.destroy(false);}.bind(this),g.SUBSCRIBE_NEW);g.subscribe('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION',this.destroy.bind(this,false));},registerEscapeKeyHandler:function(){k.listen(document.documentElement,'keydown',function(event){if(k.getKeyCode(event)===m.ESC)this.destroy(false);}.bind(this));},registerClickHandler:function(){this.actionLinks=j.find(this.root,'div.fbPhotosPhotoActions');var u=j.scry(this.root,'.startCropping');if(u.length===0)return;for(var v=0;v<u.length;v++){if(this.clickHandlers.indexOf(u[v])!==-1)continue;k.listen(u[v],'click',function(){q.log(null,this.options.uid,q.action.MAKE_PROFILE);this.start();return false;}.bind(this));this.clickHandlers.push(u[v]);}},start:function(){if(this.photocrop)return;q.log(q.step.CROP);this.cropLink=j.find(this.actionLinks,'a.fbPhotoActionsCrop');if(h.hasClass(this.cropLink,'profileAlbum')){new i().setTitle("Make Profile Picture").setBody("You've used this photo as your profile picture before. Do you want to use it again?").setButtons([i.CONFIRM,i.CANCEL]).setModal(true).setHandler(function(){setTimeout(this.reuseProfilePic.bind(this),0);return false;}.bind(this)).setCancelHandler(function(){this.cancelAndStopEvent();}.bind(this)).show();return false;}h.addClass(this.cropLink,'croppingModeOn');h.addClass(this.root,'croppingMode');var u=j.find(this.root,'img.fbPhotoImage'),v=j.find(this.root,'a.doneCroppingLink'),w=j.find(this.root,'a.cancelCroppingLink'),x=j.find(this.cropLink,'.doneCropping');this.wrapper=j.create('div');h.addClass(this.wrapper,'stageCropper');j.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=u.parentNode.style.marginTop;k.listen(this.wrapper,'click',function(event){k.kill(event);});k.listen(v,'click',this.done.bind(this));k.listen(w,'click',this.cancelAndStopEvent.bind(this));k.listen(x,'click',this.done.bind(this));var y=this.photoPermalink.stream.getCurrentImageData(),z=(function(){this.photocrop=new n(u,{target:this.wrapper},y?y.originalDimensions||y.dimensions:null);}).bind(this);if(u.complete){z();}else k.listen(u,'load',z);return false;},done:function(){var u=o.getInstance().getCurrentPhotoInfo();q.log(q.step.LOADING);var v=this.getProfilePicTarget(u).id,w=this.destroy(true);if(!w)return false;new p(u.fbid,u.owner,v,w).setSuccessURI('profile.php?id='+v).setErrorURI('photo.php?pid='+u.pid+'&id='+u.owner).setProfilePhotoSource(this.options.source).setProfilePhotoMethod('existing').send();return false;},cancelAndStopEvent:function(){q.log(q.step.CANCEL);this.destroy(false);return false;},destroy:function(u){if(!this.photocrop){if(!u&&this.wrapper){j.remove(this.wrapper);this.wrapper=null;}return null;}h.removeClass(this.cropLink,'croppingModeOn');h.removeClass(this.root,'croppingMode');if(u){h.addClass(this.root,'profilePicSavingMode');}else{j.remove(this.wrapper);this.wrapper=null;}var v=this.photocrop.done(u);this.photocrop=null;return v;},reuseProfilePic:function(){var u=o.getInstance().getCurrentPhotoInfo(),v=this.getProfilePicTarget(u),w=r({pid:u.pid,owner:u.owner,id:v.id,type:v.type,profile_pic_id:v.id},this.options.postParams);l.post('/pic_upload.php',w);return false;},getProfilePicTarget:function(u){if(h.hasClass(this.cropLink,'makePageProfile'))return {id:u.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};e.exports=t;});
__d("legacy:fb-photos-permalink-js",["PhotoPermalink"],function(a,b,c,d){a.PhotoPermalink=b('PhotoPermalink');},3);
__d("PhotoTags",["Arbiter","CSS","DOM","Event","Parent","PhotosConst","cx","ge"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(p,q,r){"use strict";this.tagTargets=p;this.tagBox=q;this.version=r||l.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.forEach(function(s){this.handlers.push(j.listen(s,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==l.VIEWER_SNOWLIFT)this.subscriptions.push(g.subscribe("PhotoSnowlift.PAGE",this.hideTags.bind(this)));}o.prototype.showTag=function(event){"use strict";var p=event.getTarget(),q=h.hasClass(p,'taggee'),r=h.hasClass(p,"_54ru"),s=null;if(q){s=p.getAttribute('data-tag');}else if(r){var t=k.byTag(p,'a');s=t&&t.getAttribute('data-tag');}if(!s){p=k.byClass(p,'taggee');if(p)s=p.getAttribute('data-tag');}var u=this.version==l.VIEWER_PERMALINK?'perm:tag:'+s:'tag:'+s,v=u&&n(u);if(v){h.addClass(v,'showTag');h.addClass(this.tagBox,'showingTag');}};o.prototype.hideTags=function(){"use strict";h.removeClass(this.tagBox,'showingTag');i.scry(this.tagBox,'div.showTag').forEach(function(p){h.removeClass(p,'showTag');});};o.prototype.destroy=function(){"use strict";for(var p in this.handlers)this.handlers[p].remove();this.subscriptions.forEach(g.unsubscribe.bind(g));};e.exports=o;});
__d("legacy:PhotoTags",["PhotoTags"],function(a,b,c,d){a.PhotoTags=b('PhotoTags');},3);
__d("TagToken",["DOM","Token"],function(a,b,c,d,e,f,g,h){for(var i in h)if(h.hasOwnProperty(i))k[i]=h[i];var j=h===null?null:h.prototype;k.prototype=Object.create(j);k.prototype.constructor=k;k.__superConstructor__=h;function k(l){"use strict";h.call(this,l,'tag');}k.prototype.createElement=function(){"use strict";var l=this.isFreeform(),m=g.create('span',{className:'separator'},', '),n=g.create(l?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!l)n.href=this.getInfo().path;return g.create('span',{className:'tagItem'},[m,n]);};e.exports=k;});
__d("TagTokenizer",["Arbiter","CSS","DOM","Parent","TagToken","Tokenizer","createObjectFrom","ge","tx"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){for(var p in l)if(l.hasOwnProperty(p))r[p]=l[p];var q=l===null?null:l.prototype;r.prototype=Object.create(q);r.prototype.constructor=r;r.__superConstructor__=l;function r(s,t,u,v){"use strict";l.call(this,u,v);g.subscribe('PhotoInlineEditor.CANCEL_INLINE_EDITING',this.updateTokenareaVisibility.bind(this),g.SUBSCRIBE_NEW);this.appphoto=t;g.subscribe(s.getInstance().getEventString('DATA_CHANGE'),this.setup.bind(this),g.SUBSCRIBE_NEW);}r.prototype.setup=function(s,t){"use strict";this.appphoto=t.byapp;this.byowner=t.isowner;return this.reset();};r.prototype.reset=function(){"use strict";var s=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var t=this.getWithTagTokenElements().map(function(u){return this._tokenKey(this.getTokenDataFromTag(u));}.bind(this));this.withTagKeys=m(t);return q.reset.call(this,s);};r.prototype.processEvents=function(event,s,t){"use strict";if(j.byClass(s,'remove')){var u=this.getTokenFromElement(t);u=this.addTokenData(u,s);this.removeToken(u);event.kill();}};r.prototype.insertToken=function(s){"use strict";return null;};r.prototype.removeToken=function(s){"use strict";if(this.appphoto){return this.replaceToken(s);}else{this.inform('removeToken',s);g.inform('Form/change',{node:this.element});}};r.prototype.addTokenData=function(s,t){"use strict";if(j.byClass(t,'blockuser'))s.blockUser=true;return s;};r.prototype.getTokenDataFromTag=function(s){"use strict";return {uid:i.find(s,'input').value,text:i.getText(i.find(s,'.taggee'))};};r.prototype.getTokenElementFromTarget=function(s){"use strict";return j.byClass(s,'tagItem');};r.prototype.getTokenElements=function(){"use strict";return i.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));};r.prototype.getWithTagTokenElements=function(){"use strict";return i.scry(this.tokenarea,'span.withTagItem');};r.prototype.filterNonTokenElements=function(s){"use strict";return !h.hasClass(s,'markasspam')&&!h.hasClass(s,'reported')&&!h.hasClass(s,'withTagItem');};r.prototype.createToken=function(s,t){"use strict";var u=this.getToken(this._tokenKey(s));u=u||new k(s);t&&u.setElement(t);return u;};r.prototype.updateTokenareaVisibility=function(){"use strict";var s=this.getTokenElements().filter(function(v){return h.shown(v);}),t=this.getWithTagTokenElements(),u=i.scry(this.tokenarea,'span.ogTagItem');h.conditionShow(this.tokenarea,s.length!==0||t.length!==0||u.length!==0);};r.prototype.replaceToken=function(s){"use strict";if(!s)return;var t=this.tokens.indexOf(s);if(t<0)return;this.tokens.splice(this.tokens.indexOf(s),1);delete this.unique[this._tokenKey(s.getInfo())];var u=n('tagspam'+s.getValue());u&&i.remove(u);var v=[' [',"Tag Removed.",' '];v.push(i.create('a',{onclick:this.markAsSpam.bind(this,s.getValue())},"Mark tag as spam"));v.push('] ');var w=i.create('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+s.getValue()},v);i.replace(s.getElement(),w);this.updateTokenarea();this.inform('removeToken',s);g.inform('Form/change',{node:this.element});};r.prototype.markAsSpam=function(s){"use strict";var t=n('tagspam'+s),u=[' [',"Tag Reported",'] '],v=i.create('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+s},u);i.replace(t,v);this.inform('markTagAsSpam',s);};e.exports=r;});
__d("TagTypeaheadView",["AsyncRequest","ContextualTypeaheadView","CSS","DOM","Parent"],function(a,b,c,d,e,f,g,h,i,j,k){for(var l in h)if(h.hasOwnProperty(l))n[l]=h[l];var m=h===null?null:h.prototype;n.prototype=Object.create(m);n.prototype.constructor=n;n.__superConstructor__=h;function n(o,p){"use strict";h.call(this,o,p);this.hintText=p.hintText;this.userEd=p.userEd;this.origAutoSelect=p.autoSelect;this.setSuggestions(p.suggestions);}n.prototype.init=function(){"use strict";i.addClass(this.element,'uiTagTypeaheadView');m.init.call(this);};n.prototype.buildResults=function(o){"use strict";if(!this.value&&this.hintText)o.unshift({subtext:this.hintText,type:'hintText'});if(this.userEd){new g().setURI('/ajax/fof/user_education.php').setData({increment:1}).send();o.unshift({subtext:this.userEd,type:'userEdText'});}var p=m.buildResults.call(this,o);if(this.userEd)o.shift();if(!this.value)o.shift();return p;};n.prototype.show=function(){"use strict";var o=j.scry(this.context,'.typeaheadBackdrop');if(o.length>0)i.addClass(o[0],'resultsPresent');return m.show.call(this);};n.prototype.hide=function(){"use strict";var o=j.scry(this.context,'.typeaheadBackdrop');if(o.length>0)i.removeClass(o[0],'resultsPresent');return m.hide.call(this);};n.prototype.render=function(o,p,q){"use strict";this.autoSelect=this.origAutoSelect&&o.length;this.disableAutoSelect=o.length===0;m.render.call(this,o,p,q);};n.prototype.getItems=function(){"use strict";var o=m.getItems.call(this);if(!this.value)o.shift();if(this.userEd)o.shift();return o;};n.prototype.getSuggestions=function(){"use strict";return this.suggestions;};n.prototype.setSuggestions=function(o){"use strict";this.suggestions=o?o.map(String):[];this.visible=!!this.suggestions.length;};n.prototype.addSuggestion=function(o){"use strict";this.suggestions.unshift(o);};n.prototype.addTypeaheadFlip=function(o){"use strict";i.addClass(this.element,o);};n.prototype.removeTypeaheadFlip=function(o){"use strict";i.removeClass(this.element,o);};n.prototype.getContext=function(){"use strict";var o=k.byClass(this.element,'typeaheadContainer');if(o){return o;}else return m.getContext.call(this);};e.exports=n;});
__d("TypeaheadHintText",["copyProperties","emptyFunction"],function(a,b,c,d,e,f,g,h){function i(j){"use strict";this._typeahead=j;}i.prototype.enable=function(){"use strict";this._typeahead.getCore().resetOnKeyup=false;};g(i.prototype,{disable:h});e.exports=i;});
__d("legacy:HintTextTypeaheadBehavior",["TypeaheadHintText"],function(a,b,c,d,e,f,g){if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.hintText=function(h){h.enableBehavior(g);};},3);